{% extends 'base.html' %}

{% block content %}
    <div class="page-title">
        <h1>系统设置</h1>
        <p>管理AI模型和系统配置</p>
    </div>

    <div class="settings-container">
        <!-- 自定义模型设置 -->
        <div class="card">
            <h2 class="card-title">
                <i class="fas fa-cog"></i>
                自定义模型管理
            </h2>
            
            <!-- 添加新模型 -->
            <div class="add-model-section">
                <h3 class="section-subtitle">添加新模型</h3>
                <form id="addModelForm" class="model-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="apiUrl" class="form-label">
                                <i class="fas fa-link"></i>
                                API URL
                            </label>
                            <input 
                                type="text" 
                                id="apiUrl" 
                                name="apiUrl" 
                                class="form-input" 
                                placeholder="例如：https://api.openai.com/v1/chat/completions"
                                required
                            >
                            <small class="form-help">模型API的完整URL</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="apiKey" class="form-label">
                                <i class="fas fa-key"></i>
                                API KEY
                            </label>
                            <input 
                                type="password" 
                                id="apiKey" 
                                name="apiKey" 
                                class="form-input" 
                                placeholder="例如：sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                required
                            >
                            <small class="form-help">API密钥，用于认证</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="modelName" class="form-label">
                                <i class="fas fa-brain"></i>
                                模型名称
                            </label>
                            <div class="input-with-btn">
                                <input 
                                    type="text" 
                                    id="modelName" 
                                    name="modelName" 
                                    class="form-input" 
                                    placeholder="例如：gpt-4o-mini"
                                >
                                <button 
                                    type="button" 
                                    class="btn btn-secondary" 
                                    id="fetchModelsBtn" 
                                    onclick="fetchModels()"
                                    disabled
                                >
                                    <i class="fas fa-download"></i>
                                    获取模型
                                </button>
                            </div>
                            <small class="form-help">模型的名称，可手动输入或点击获取按钮自动获取</small>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="modelDescription" class="form-label">
                                <i class="fas fa-info-circle"></i>
                                模型描述（可选）
                            </label>
                            <textarea 
                                id="modelDescription" 
                                name="modelDescription" 
                                class="form-textarea" 
                                rows="2" 
                                placeholder="简短描述模型的特点或用途"
                            ></textarea>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            添加模型
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                            重置
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- 模型列表 -->
            <div class="model-list-section">
                <h3 class="section-subtitle">已添加的模型</h3>
                {% if custom_models %}
                    <div class="model-list" id="modelList">
                        {% for model in custom_models %}
                            <div class="model-item card">
                                <div class="model-info">
                                    <div class="model-header">
                                        <div class="model-name">{{ model.name }}</div>
                                        <div class="model-status">
                                            <span class="status-badge active">已启用</span>
                                        </div>
                                    </div>
                                    <div class="model-details">
                                        <div class="model-api-url">{{ model.api_url }}</div>
                                        {% if model.description %}
                                            <div class="model-description">{{ model.description }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="model-actions">
                                    <button class="action-btn edit-btn" onclick="editModel('{{ model.id }}')" title="编辑模型">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteModel('{{ model.id }}')" title="删除模型">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-models">
                        <i class="fas fa-inbox"></i>
                        <p>暂无自定义模型</p>
                        <p class="hint">请在上方添加您的第一个自定义模型</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // 表单验证：API URL和API Key填写完整后启用获取模型按钮
        document.addEventListener('DOMContentLoaded', function() {
            const apiUrlInput = document.getElementById('apiUrl');
            const apiKeyInput = document.getElementById('apiKey');
            const fetchModelsBtn = document.getElementById('fetchModelsBtn');
            
            function validateApiInputs() {
                if (apiUrlInput.value.trim() && apiKeyInput.value.trim()) {
                    fetchModelsBtn.disabled = false;
                } else {
                    fetchModelsBtn.disabled = true;
                }
            }
            
            apiUrlInput.addEventListener('input', validateApiInputs);
            apiKeyInput.addEventListener('input', validateApiInputs);
            
            // 添加模型表单提交
            const addModelForm = document.getElementById('addModelForm');
            addModelForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    apiUrl: document.getElementById('apiUrl').value.trim(),
                    apiKey: document.getElementById('apiKey').value.trim(),
                    modelName: document.getElementById('modelName').value.trim(),
                    modelDescription: document.getElementById('modelDescription').value.trim()
                };
                
                try {
                    const response = await fetch('/api/settings/models', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('模型添加成功！');
                        window.location.reload();
                    } else {
                        alert('添加失败: ' + result.error);
                    }
                } catch (error) {
                    console.error('添加模型出错:', error);
                    alert('添加失败: ' + error.message);
                }
            });
        });
        
        // 获取模型列表
        async function fetchModels() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiUrl || !apiKey) {
                alert('请先填写API URL和API Key');
                return;
            }
            
            const fetchBtn = document.getElementById('fetchModelsBtn');
            const originalText = fetchBtn.innerHTML;
            fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 获取中...';
            fetchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/settings/fetch-models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ apiUrl, apiKey })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 显示模型选择
                    showModelSelection(result.models);
                } else {
                    alert('获取模型失败: ' + result.error);
                }
            } catch (error) {
                console.error('获取模型出错:', error);
                alert('获取模型失败: ' + error.message);
            } finally {
                fetchBtn.innerHTML = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // 显示模型选择
        function showModelSelection(models) {
            let modelListHTML = '<div class="model-selection-modal">';
            modelListHTML += '<div class="modal-content">';
            modelListHTML += '<div class="modal-header">';
            modelListHTML += '<h3>选择模型</h3>';
            modelListHTML += '<button class="modal-close" onclick="closeModelSelection()">&times;</button>';
            modelListHTML += '</div>';
            modelListHTML += '<div class="modal-body">';
            
            if (models.length > 0) {
                modelListHTML += '<div class="model-options">';
                models.forEach(model => {
                    modelListHTML += `<div class="model-option">`;
                    modelListHTML += `<label class="model-option-label">`;
                    modelListHTML += `<input type="radio" name="selectedModel" value="${model}">`;
                    modelListHTML += `<span class="model-option-text">${model}</span>`;
                    modelListHTML += `</label>`;
                    modelListHTML += `</div>`;
                });
                modelListHTML += '</div>';
                modelListHTML += '<div class="modal-actions">';
                modelListHTML += '<button class="btn btn-primary" onclick="selectModel()">确定</button>';
                modelListHTML += '<button class="btn btn-secondary" onclick="closeModelSelection()">取消</button>';
                modelListHTML += '</div>';
            } else {
                modelListHTML += '<p class="no-models-found">未找到可用模型</p>';
                modelListHTML += '<div class="modal-actions">';
                modelListHTML += '<button class="btn btn-primary" onclick="closeModelSelection()">关闭</button>';
                modelListHTML += '</div>';
            }
            
            modelListHTML += '</div>';
            modelListHTML += '</div>';
            modelListHTML += '</div>';
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modelListHTML);
        }
        
        // 关闭模型选择
        function closeModelSelection() {
            const modal = document.querySelector('.model-selection-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 选择模型
        function selectModel() {
            const selectedModel = document.querySelector('input[name="selectedModel"]:checked');
            if (selectedModel) {
                document.getElementById('modelName').value = selectedModel.value;
            }
            closeModelSelection();
        }
        
        // 编辑模型
        function editModel(modelId) {
            // 这里可以实现编辑模型的功能
            alert(`编辑模型 ${modelId}`);
        }
        
        // 删除模型
        async function deleteModel(modelId) {
            if (confirm('确定要删除这个模型吗？')) {
                try {
                    const response = await fetch(`/api/settings/models/${modelId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('模型删除成功！');
                        window.location.reload();
                    } else {
                        alert('删除失败: ' + result.error);
                    }
                } catch (error) {
                    console.error('删除模型出错:', error);
                    alert('删除失败: ' + error.message);
                }
            }
        }
    </script>
{% endblock %}
