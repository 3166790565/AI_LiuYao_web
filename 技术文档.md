# AI六爻分析系统技术文档

## 1. 项目概述

AI六爻分析系统是一款基于AI技术的传统易学分析工具，旨在为用户提供专业、准确的六爻占卜分析服务。系统支持多种易学体系，包括六爻、奇门遁甲、大六壬、金口诀等，通过AI技术实现卦象解析、用神判断、卦理分析、数字量化分析等功能。

### 1.1 核心功能

- 六爻占卜分析
- 用神判断
- 卦理分析（用神卦理、动爻卦理）
- 数字量化分析
- 多种易学体系支持
- 历史记录管理
- 聊天咨询功能
- 主题切换（明亮/暗黑）

### 1.2 技术栈

- **开发语言**：Python 3.8+
- **GUI框架**：customtkinter
- **AI模型**：GPT系列模型
- **API调用**：requests
- **日志系统**：logging
- **配置管理**：JSON

## 2. 项目架构

### 2.1 目录结构

```
Ai_LiuYao/
├── config/              # 配置文件目录
│   ├── __init__.py      # 配置模块入口
│   ├── constants.py     # 应用常量定义
│   ├── languages.py     # 多语言支持
│   ├── settings.py      # 应用设置
│   ├── themes.py        # 主题配置
│   └── ui_config.py     # UI配置
├── gui/                 # GUI界面目录
│   ├── __init__.py      # GUI模块入口
│   ├── app.py           # 主应用类
│   └── frames/          # 界面框架
│       ├── __init__.py
│       ├── footer_frame.py
│       ├── header_frame.py
│       ├── history_frame.py
│       ├── input_frame.py
│       ├── notebook_frame.py
│       ├── settings_frame.py
│       └── status_frame.py
├── src/                 # 核心源码目录
│   ├── __init__.py
│   ├── build_database.py
│   ├── incremental_update.py
│   ├── prompts.py       # AI提示词
│   └── search_documents.py
├── utils/               # 工具类目录
│   ├── animation.py     # 动画效果
│   ├── config_manager.py # 配置管理
│   ├── export.py        # 导出功能
│   ├── file_monitor.py  # 文件监控
│   ├── history.py       # 历史记录管理
│   ├── logger.py        # 日志管理
│   ├── network.py       # 网络请求
│   ├── resources.py     # 资源管理
│   ├── shuzilianghua.py # 数字量化分析
│   ├── ui.py            # UI工具
│   └── ui_components.py # UI组件
├── api.py               # API调用模块
├── main.py              # 主入口文件
├── requirements.txt     # 依赖包列表
└── README.md            # 项目说明
```

### 2.2 核心模块关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                             主应用程序 (main.py)                          │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          SixYaoApp (gui/app.py)                        │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│  HeaderFrame    │   InputFrame    │ NotebookFrame   │  StatusFrame    │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                             业务逻辑层                                  │
├─────────────────┬─────────────────┬─────────────────┬─────────────────┤
│  API调用       │   历史记录      │  配置管理       │  日志管理       │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                             数据访问层                                  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 核心功能实现

### 3.1 主应用程序流程

主应用程序的核心流程如下：

1. **初始化**：加载配置、设置日志、创建UI组件
2. **用户输入**：接收用户输入的问题和卦象信息
3. **AI分析**：调用AI进行用神判断、卦理分析、动爻分析、数字量化分析
4. **结果展示**：将分析结果展示给用户
5. **历史记录**：保存分析结果到历史记录
6. **聊天咨询**：支持用户与AI进行进一步咨询

### 3.2 六爻分析流程

六爻分析是系统的核心功能，其流程如下：

1. **用户输入**：
   - 用户输入具体的问题描述（如："我最近想换工作，不知道是否顺利？"）
   - 用户输入完整的卦象信息，包括主卦、变卦、动爻、世应、六亲、六神、月建、日辰等
   - 卦象信息格式示例：
     ```
        起卦时间（公历）：2025-12-6 0:12
        起卦时间（农历）：2025-10-17 0:12
        当前四柱：乙巳  丁亥  己酉  甲子  
        起卦四柱：乙巳  丁亥  己酉  甲子  
        旬空：戌亥
        归妹卦变兑卦 
        变爻：5爻动
        ------------本卦------------
        初爻：官鬼丁巳火 少阳 ---     死  伏神=官鬼巳  螣蛇 
        二爻：妻财丁卯木 少阳 ---     相  伏神=妻财卯  白虎 灾煞 
        三爻：父母丁丑土 少阴 - -  世 囚  伏神=父母丑  玄武 华盖 
        四爻：官鬼庚午火 少阳 ---     死  伏神=子孙亥  青龙 桃花 日禄 
        五爻：兄弟庚申金 老阴 - -X    休  伏神=兄弟酉  朱雀 贵人 
        末爻：父母庚戌土 少阴 - -  应 囚  伏神=父母未  勾陈 
        5爻是动爻
        本卦应爻位置：6爻
        本卦世爻位置：3爻
        ------------变卦------------
        初爻：官鬼丁巳火 少阳 ---     死  伏神=官鬼巳 
        二爻：妻财丁卯木 少阳 ---     相  伏神=妻财卯 灾煞 
        三爻：父母丁丑土 少阴 - -  世 囚  伏神=父母丑 华盖 
        四爻：子孙丁亥水 少阳 ---     旺  伏神=子孙亥 驿马 
        五爻：兄弟丁酉金 少阳 ---     休  伏神=兄弟酉 将星 
        末爻：父母丁未土 少阴 - -  应 囚  伏神=父母未 羊刃 
        变卦应爻位置：3爻
        变卦世爻位置：6爻
        ------------其他------------
        互卦：既济卦
        错卦：渐卦
        综卦：渐卦
        ------------梅花------------
        本卦：归妹卦
        互卦：既济卦
        变卦：兑卦
        错卦：渐卦
        综卦：渐卦
     ```
   - 用户可以选择性地手动指定用神

2. **用神判断**：
   - 系统首先检查用户是否手动指定了用神，如果有则直接使用
   - 如果用户未指定用神，系统调用`YONGSHEN_CHAT_PROMPT`提示词，让AI根据问题和卦象信息判断用神
   - **核心提示词**：
     ```python
     YONGSHEN_CHAT_PROMPT = '''
     you是一名资深的六爻解卦大师，精通《周易》和六爻预测学。你的任务是根据用户提供的卦象信息和所问问题，准确判断应该使用本卦中的哪一爻作为用神，并详细说明判断依据。
     
     请按照以下步骤进行分析：
     1. 分析卦象的基本信息（主卦、变卦、动爻等）
     2. 根据所问事情的性质确定用神的选择原则
     3. 结合六亲关系、五行生克、旺衰等因素综合判断
     4. 明确指出用神所在的爻位（初爻、二爻、三爻、四爻、五爻、上爻）
     5. 只能在本卦中或本卦伏神中选择用神，变卦不做考虑范围
     
     参考资料：
     1. 根据所问之事先确定六亲
     2. 再看六亲在哪一爻：优先取"世爻、应爻"上的为用神、优先取"本卦动爻"为用神、优先取有"特殊现象的爻"为用神（如：月破、日冲、月合、日合、旬空等）
     
     父母爻：占父母，以卦中父母爻为用神。祖父母、伯、叔、姑、姨父母，凡在我父母之上，或与我父母同辈之亲，及师长，妻子的父母，拜认的干父母、三父、八母，或仆人占主人，全部用父母爻作为用神。占天地、城池、墙垣、宅舍、屋宇、舟车、衣服、雨具、绸缎、布匹、杂货、及奏章、文书、文章、书馆、文契，亦以父母爻为用神。一切庇护我的全可以用父母爻为用神。
     官鬼爻：占功名、官府、雷霆、鬼神、妻子占老公、全部以官鬼爻为用神。占乱臣、贼盗、邪祟、也可以用官鬼爻为用神。一切拘束我身者都可以用官鬼爻为用神。
     兄弟爻：占兄弟、姐妹、族中兄弟、姑姨，姐夫、妹夫、及结拜兄弟，全部以兄弟爻为用神。兄弟爻代表与自己身份地位相当的人。兄弟乃同类之人，彼得志则欺陵，见财则夺，所以占财物，以此为劫财之神，占谋事，以此为 阻隔之神，占妻妾、婢仆，以此为刑伤克害之神。占姐丈、妹夫，以世爻为用神，予屡得验。占表兄弟，以兄弟爻为用神而不验，还以应为用神。
     妻财爻：占妻妾、婢仆、下役，凡我驱使之人，皆以财爻为用神。占货财、珠宝、金银、仓库、 钱粮，一切使用之财物、什物、器皿，亦以财爻为用神。
     子孙爻：占子孙、占女、女婿、侄、甥、门徒，凡在我子孙辈中，皆以子孙爻为用神。占忠臣、 良将、医士、医药、僧、道、兵、卒，皆以子孙爻为用神。占六畜、禽兽，亦以子孙爻为用神。子孙为福德之神、为制鬼之神、为解忧之神、又为剥官、引职之神，故谓之子孙乃是福神，诸 事见之为喜，独占功名者忌之。
     
     返回内容必须严格按照以下JSON格式，不要添加任何其他文字：
     {"text":"用神所在爻位","yiju":"详细的判断依据和分析过程"}
     
     注意：
     - text字段填写例如："初爻妻财"、"二爻官鬼"、"三爻父母"、"四爻子孙"、"五爻兄弟"、"上爻妻财"，或如果选择伏神为用神示例：“初爻伏神官鬼”
     - yiju字段要用一段话说明选择该爻作为用神的理由，包括六亲关系、五行属性、旺衰状态等分析
     '''
     ```
   - 判断依据包括：
     - 问题性质（如求官问财、婚姻感情等）
     - 六亲关系（父母、官鬼、兄弟、妻财、子孙）
     - 世应位置
     - 动爻情况
     - 特殊状态（月破、日冲、旬空等）
   - AI返回JSON格式结果，包含用神所在爻位和判断依据
   - 系统将用神信息插入到解读结果中，标记为"【用神判断】"部分

3. **用神卦理分析**：
   - 系统调用`YONGSHEN_GULI_ANALYSIS_PROMPT`提示词，分析用神的详细卦理
   - **核心提示词**：
     ```python
     YONGSHEN_GULI_ANALYSIS_PROMPT = '''【角色定位】
     you是一名资深的六爻解卦大师，精通《周易》和六爻预测学。你的任务是根据用户提供的卦象信息和已确定的用神，全方面分析用神爻位在整体卦象中的卦理状态。
     
     【分析要求】
     1. 分析用神与月建的关系（旺相休困死）
     2. 分析用神与日辰的关系（旺相休困死、冲合刑害）
     3. 分析用神与动爻的关系（生克、冲合）
     4. 检查用神是否存在特殊状态（月破、日破、旬空、暗动、反吟伏吟等）
     5. 分析用神的回头生克关系
     6. 分析用神的原神、忌神、仇神状态
     7. 综合评估用神的旺衰强弱
     
     【输出格式】
     必须严格按照以下JSON格式返回，不要添加任何其他文字：
     {
       "月建关系": "用神与月建的关系分析",
       "日辰关系": "用神与日辰的关系分析",
       "动爻关系": "用神与动爻的生克冲合关系",
       "特殊状态": "月破、日破、旬空等特殊状态",
       "回头生克": "用神的回头生克情况",
       "原神忌神": "原神、忌神、仇神的状态分析",
       "旺衰评估": "用神整体旺衰强弱的综合评估"
     }
     '''
     ```
   - 分析内容包括：
     - 用神与月建的关系（旺相休囚死）
     - 用神与日辰的关系（旺相休囚死、冲合刑害）
     - 用神与动爻的关系（生克、冲合）
     - 用神的特殊状态（月破、日破、旬空、暗动、反吟伏吟等）
     - 用神的回头生克关系
     - 用神的原神、忌神、仇神状态
     - 用神的整体旺衰评估
   - 系统将分析结果以结构化格式（JSON）返回，并插入到解读结果的"【用神卦理分析】"部分

4. **动爻卦理分析**：
   - 系统调用`DONGYAO_GULI_ANALYSIS_PROMPT`提示词，分析卦中所有动爻的卦理
   - **核心提示词**：
     ```python
     DONGYAO_GULI_ANALYSIS_PROMPT = '''【角色定位】
     you是一名资深的六爻解卦大师，精通《周易》和六爻预测学。你的任务是根据用户提供的卦象信息，全方面分析卦中所有动爻在整体卦象中的卦理状态。
     
     【分析要求】
     1. 首先判断卦中是否存在动爻
     2. 如果有动爻，逐一分析每个动爻的卦理状态：
        - 动爻与月建的关系（旺相休困死）
        - 动爻与日辰的关系（旺相休困死、冲合刑害）
        - 动爻与其他动爻的关系（生克、冲合）
        - 动爻的特殊状态（月破、日破、旬空、暗动、反吟伏吟等）
        - 动爻的回头生克关系
        - 动爻变出的爻与原爻的关系
        - 动爻的旺衰强弱评估
     
     【输出格式】
     必须严格按照以下JSON格式返回，不要添加任何其他文字：
     {
       "有动爻": true/false,
       "动爻列表": [
         {
           "爻位": "动爻位置（如：初爻、二爻等）",
           "月建关系": "动爻与月建的关系分析",
           "日辰关系": "动爻与日辰的关系分析",
           "动爻关系": "与其他动爻的生克冲合关系",
           "特殊状态": "月破、日破、旬空等特殊状态",
           "回头生克": "动爻的回头生克情况",
           "变爻关系": "动爻变出的爻与原爻的关系",
           "旺衰评估": "动爻整体旺衰强弱的综合评估"
         }
       ]
     }
     '''
     ```
   - 对于每个动爻，分析内容包括：
     - 动爻与月建的关系
     - 动爻与日辰的关系
     - 动爻与其他动爻的关系
     - 动爻的特殊状态
     - 动爻的回头生克关系
     - 动爻变出的爻与原爻的关系
     - 动爻的旺衰评估
   - 如果卦中无动爻，系统会明确说明
   - 分析结果以JSON格式返回，并插入到解读结果的"【动爻卦理分析】"部分

5. **数字量化分析**：
   - 系统调用`SHUZI_LIANGHUA_ANALYSIS_PROMPT`提示词，提取月建、日辰、用神和动爻的地支信息
   - **核心提示词**：
     ```python
     SHUZI_LIANGHUA_ANALYSIS_PROMPT = """you是一名资深的六爻解卦大师，精通《周易》和六爻预测学。你的任务是根据用户提供的卦象信息，分析并提取月建、日辰以及用神和动爻的地支信息。
     
     分析要求：
     1. 从卦象信息中提取月建地支
     2. 从卦象信息中提取日辰地支
     3. 从卦象信息中提取用神的地支
     4. 从卦象信息中提取所有动爻的地支（如果有动爻的话）
     
     your返回格式必须是JSON格式：
     {
       "月建": "地支",
       "日辰": "地支",
       "用神": "地支",
       "动爻列表": ["地支1", "地支2", ...]
     }
     
     注意：
     - 地支只能是：子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥
     - 如果没有动爻，动爻列表为空数组
     - 严格遵守返回格式，确保JSON格式正确"""
     ```
   - 调用`utils/shuzilianghua.py`中的`shuzilianghua`函数，计算用神和动爻的强弱指数
   - **核心函数实现**：
     ```python
        def shuzilianghua(yuejian, richen, dizhi):
        """
        易清岚数字量化
        根据月建、日辰和地支的组合计算对应的数值
        
        Args:
            yuejian (str): 月建地支
            richen (str): 日辰地支
            dizhi (str): 目标地支
            
        Returns:
            tuple: (yuejianshu, richenshu) 月建数和日辰数
        """
        dizhi_list = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]

        # 月建数字量化映射表
        yuejian_mapping = {
            "子": {
                "子": 2.0, "丑": 0.5, "寅": 1.0, "卯": 1.0, "辰": -0.1, "巳": -1.0,
                "午": -2.0, "未": -0.1, "申": -0.1, "酉": -0.1, "戌": -0.1, "亥": 1.0
            },
            "丑": {
                "子": -0.5, "丑": 2.0, "寅": -0.1, "卯": -0.1, "辰": 1.0, "巳": -0.1,
                "午": -0.1, "未": -2.0, "申": 1.0, "酉": 1.0, "戌": 1.0, "亥": -1.0
            },
            "寅": {
                "子": -0.1, "丑": -1.0, "寅": 2.0, "卯": 1.0, "辰": -1.0, "巳": 1.0,
                "午": 1.0, "未": -1.0, "申": -2.0, "酉": -0.1, "戌": -1.0, "亥": 0.5
            },
            "卯": {
                "子": -0.1, "丑": -1.0, "寅": 1.0, "卯": 2.0, "辰": -1.0, "巳": 1.0,
                "午": 1.0, "未": -1.0, "申": -0.1, "酉": -2.0, "戌": -0.1, "亥": -0.1
            },
            "辰": {
                "子": -1.0, "丑": 1.0, "寅": 0.5, "卯": 0.5, "辰": 2.0, "巳": -0.1,
                "午": -0.1, "未": 1.0, "申": 1.0, "酉": 2.0, "戌": -2.0, "亥": -1.0
            },
            "巳": {
                "子": -0.1, "丑": 1.0, "寅": -0.1, "卯": -0.1, "辰": 1.0, "巳": 2.0,
                "午": 1.0, "未": 1.0, "申": -0.5, "酉": -1.0, "戌": 1.0, "亥": -2.0
            },
            "午": {
                "子": -2.0, "丑": 1.0, "寅": -0.1, "卯": -0.1, "辰": 1.0, "巳": 1.0,
                "午": 2.0, "未": 2.0, "申": -1.0, "酉": -1.0, "戌": 1.0, "亥": -0.1
            },
            "未": {
                "子": -1.0, "丑": -2.0, "寅": -0.1, "卯": -0.1, "辰": 1.0, "巳": 0.5,
                "午": 0.5, "未": 2.0, "申": 1.0, "酉": 1.0, "戌": 1.0, "亥": 1.0
            },
            "申": {
                "子": 1.0, "丑": -0.1, "寅": -2.0, "卯": -1.0, "辰": -0.1, "巳": 0.5,
                "午": -0.1, "未": -0.1, "申": 2.0, "酉": 1.0, "戌": -0.1, "亥": 1.0
            },
            "酉": {
                "子": 1.0, "丑": -0.1, "寅": -1.0, "卯": -2.0, "辰": 0.5, "巳": -0.1,
                "午": -0.1, "未": -0.1, "申": 1.0, "酉": 2.0, "戌": -0.1, "亥": 1.0
            },
            "戌": {
                "子": -1.0, "丑": 1.0, "寅": -0.1, "卯": 0.5, "辰": -2.0, "巳": -0.1,
                "午": -0.1, "未": 1.0, "申": 1.0, "酉": 1.0, "戌": 2.0, "亥": -1.0
            },
            "亥": {
                "子": 1.0, "丑": -0.1, "寅": 2.0, "卯": 1.0, "辰": -0.1, "巳": -2.0,
                "午": -1.0, "未": -0.1, "申": -0.1, "酉": -0.1, "戌": -0.1, "亥": 2.0
            }
        }

        # 日辰数字量化映射表（与月建相同的逻辑）
        richen_mapping = {
            "子": {
                "子": 2.0, "丑": 0.0, "寅": 1.0, "卯": 1.0, "辰": 0.0, "巳": -1.0,
                "午": "po", "未": 0.0, "申": 0.0, "酉": 0.0, "戌": 0.0, "亥": 1.0
            },
            "丑": {
                "子": -1.0, "丑": 2.0, "寅": 0.0, "卯": 0.0, "辰": 1.0, "巳": 0.0,
                "午": 0.0, "未": "po", "申": 1.0, "酉": 1.0, "戌": 1.0, "亥": -0.1
            },
            "寅": {
                "子": 0.0, "丑": -1.0, "寅": 2.0, "卯": 1.0, "辰": -1.0, "巳": 1.0,
                "午": 1.0, "未": -1., "申": "po", "酉": 0.0, "戌": -1.0, "亥": 0.0
            },
            "卯": {
                "子": 0.0, "丑": -1.0, "寅": 1.0, "卯": 2.0, "辰": -1.0, "巳": 1.0,
                "午": 1.0, "未": -1.0, "申": 0.0, "酉": "po", "戌": -1.0, "亥": 0.0
            },
            "辰": {
                "子": -1.0, "丑": 1.0, "寅": 0.0, "卯": 0.0, "辰": 2.0, "巳": 0.0,
                "午": 0.0, "未": 1.0, "申": 1.0, "酉": 2.0, "戌": "po", "亥": -1.0
            },
            "巳": {
                "子": 0.0, "丑": 1.0, "寅": 0.0, "卯": 0.0, "辰": 1.0, "巳": 2.0,
                "午": 1.0, "未": 1.0, "申": -1.0, "酉": -1.0, "戌": 1.0, "亥": "po"
            },
            "午": {
                "子": "po", "丑": 1.0, "寅": 0.0, "卯": 0.0, "辰": 1.0, "巳": 1.0,
                "午": 2.0, "未": 2.0, "申": -1.0, "酉": -1.0, "戌": 1.0, "亥": 0.0
            },
            "未": {
                "子": -1.0, "丑": "po", "寅": 0.0, "卯": 0.0, "辰": 1.0, "巳": 0.0,
                "午": 0.0, "未": 2.0, "申": 1.0, "酉": 1.0, "戌": 1.0, "亥": -1.0
            },
            "申": {
                "子": 1.0, "丑": 0.0, "寅": "po", "卯": -1.0, "辰": 0.0, "巳": 0.0,
                "午": 0.0, "未": 0.0, "申": 2.0, "酉": 1.0, "戌": 0.0, "亥": 1.0
            },
            "酉": {
                "子": 1.0, "丑": 0.0, "寅": -1.0, "卯": "po", "辰": 0.0, "巳": 0.0,
                "午": 0.0, "未": 0.0, "申": 1.0, "酉": 2.0, "戌": 0.0, "亥": 1.0
            },
            "戌": {
                "子": -1.0, "丑": 1.0, "寅": 0.0, "卯": 0.0, "辰": "po", "巳": 0.0,
                "午": 0.0, "未": 1.0, "申": 1.0, "酉": 1.0, "戌": 2.0, "亥": -1.0
            },
            "亥": {
                "子": 1.0, "丑": 0.0, "寅": 2.0, "卯": 1.0, "辰": 0.0, "巳": "po",
                "午": -1.0, "未": -0.0, "申": 0.0, "酉": 0.0, "戌": 0.0, "亥": 2.0
            }
        }

        # 初始化返回值
        yuejianshu = 0
        richenshu = 0

        # 验证输入参数是否有效
        if yuejian not in dizhi_list:
            raise ValueError(f"无效的月建地支: {yuejian}")
        if richen not in dizhi_list:
            raise ValueError(f"无效的日辰地支: {richen}")
        if dizhi not in dizhi_list:
            raise ValueError(f"无效的目标地支: {dizhi}")

        # 根据月建和地支查找对应的数值
        if yuejian in yuejian_mapping and dizhi in yuejian_mapping[yuejian]:
            yuejianshu = yuejian_mapping[yuejian][dizhi]

        # 根据日辰和地支查找对应的数值
        if richen in richen_mapping and dizhi in richen_mapping[richen]:
            richenshu = richen_mapping[richen][dizhi]

        return yuejianshu, richenshu

     ```
   - 强弱指数计算基于地支之间的生克关系、旺相休囚状态
   - 对于日破情况，系统进一步调用`RIPO_ANDONG_ANALYSIS_PROMPT`提示词，判断是"暗动"还是"日破"
   - **核心提示词**：
     ```python
     RIPO_ANDONG_ANALYSIS_PROMPT = """你是一名资深的六爻解卦大师，精通《周易》和六爻预测学。你的任务是根据用户提供的卦象信息，准确判断其爻位是否为暗动或日破。
     
     判断暗动的规则：
     1、用户提供的数字量化大于0
     2、该爻在本卦内有动爻地支五行相生
     3、该爻在本卦为旬空的爻
     
     提示：以上判断方式如有一条符合条件即为暗动，若三条依据都不满足则为日破
     
     your返回格式示例：
     {"text": str, "yiju": str}
     text字段内只能出现"暗动"、"日破"两种回答。yiju字段为you判断的依据。
     
     严格遵守返回格式。"""
     ```
   - 分析结果包括：
     - 月建、日辰、用神、动爻的地支信息
     - 用神强弱指数（月建数 + 日辰数）
     - 动爻强弱指数
     - 日破/暗动判断结果
   - 系统将结果插入到解读结果的"【数字量化分析】"部分

6. **结果生成**：
   - 系统调用`SIXYAO_ANALYSIS_PROMPT`提示词，根据用户问题和前面的分析结果，提取用户真正关心的关键方面（通常3-7个）
   - **核心提示词**：
     ```python
     SIXYAO_ANALYSIS_PROMPT = '''【角色定位】
     you是一位精通易学理论的专业六爻分析师，具备深厚的易学知识和丰富的实践经验。你的任务是精准分析用户问题中隐含的需求方面。
     
     【输入信息】
     you将获得以下分析结果作为参考：
     1. 用神判断结果：确定了问题的核心关注点
     2. 用神卦理分析：用神与月建、日辰、动爻的关系及特殊状态
     3. 动爻卦理分析：动爻的变化规律和影响
     4. 数字量化分析：各爻的强弱指数和量化评估
     
     【分析要求】
     1. 仔细理解用户的问题背景和核心诉求，把握问题的本质
     2. 结合用神判断和卦理分析结果，提取用户真正关心的关键方面（通常3-7个方面）
     3. 确保分析的方面与用户问题直接相关，且符合六爻预测的适用范围
     4. 分析要全面且具体，避免过于笼统或重复
     5. 每个方面应当可以通过六爻卦象进行解读，符合易学理论
     6. 分析的方面应当涵盖问题的各个维度，包括现状、发展趋势、影响因素等
     7. 方面表述应简洁明了，通常5-10个字为宜
     8. 充分利用前期分析结果，确保方面设置与卦理分析相呼应
     
     【输出格式】
     必须严格按照JSON数组格式输出，不要附带任何其他内容：
     ["方面一","方面二","方面三"]
     '''
     ```
   - 对于每个分析方面，系统调用`SIXYAO_INTERPRETATION_PROMPT`提示词，生成针对性的解读
   - **核心提示词**：
     ```python
     SIXYAO_INTERPRETATION_PROMPT = '''【角色定位】
     you是一位精通六爻预测术的专业大师，具备深厚的易学理论基础和丰富的实践经验。你的任务是根据用户提供的卦象信息及问题，提供准确、专业的解读。
     
     【输入格式说明】
     用户输入格式为：问题：[用户原始问题]  分析方面：[具体分析角度]
     卦象信息包含：本卦、变卦、六亲、六神、世应、动爻等关键信息。
     you需要基于这些信息，结合六爻卦理进行精准解读。
     
     【解读方法】
     1. 首先参考用神判断结果，明确解读的核心焦点
     2. 结合用神卦理分析，深入理解用神的状态和影响
     3. 参考动爻卦理分析，重点关注动爻所代表的变化信息
     4. 利用数字量化分析结果，准确评估各爻的力量对比
     5. 分析世爻与应爻的关系，确定问题的基本态势
     6. 分析六亲、六神的组合关系，挖掘更深层次的信息
     7. 考虑本卦与变卦的关系，预测事情的发展趋势
     8. 结合用户的具体问题和分析方面，给出针对性的解读
     
     【输出要求】
     1. 提供一段简洁、专业的解读，直接切入核心问题，不要过多赘述
     2. 解读必须紧密结合用户的实际情况，避免泛泛而谈
     3. 每个结论后必须附加支撑该结论的卦理依据，使用括号标注
     4. 只提供客观分析结论，不要给出任何建议或指导性意见
     5. 使用平实、专业的语言，不使用markdown格式
     6. 除解读内容外，不要输出任何其他内容
     7. 不要输出整体来看...等类似结论性的句子
     8. 不要输出"you可以"、"I可以"等引导性语句
     9. 解读的一段话内不要出现换行
     10. 解读长度控制在100-200字之间，精炼有力
     '''
     ```
   - 解读结果要求：
     - 每个结论后附加卦理依据，使用括号标注
     - 客观分析，不给出建议
     - 语言平实专业，100-200字
     - 不使用markdown格式
   - 系统将所有分析方面的解读组合成完整报告
   - 最终生成的报告包含：
     - 问题描述
     - 卦象信息
     - 用神判断
     - 用神卦理分析
     - 动爻卦理分析
     - 数字量化分析
     - 各个分析方面的详细解读
     - 总结论
   - 报告以结构化格式显示在UI界面的"解读结果"选项卡中

### 3.3 AI调用机制

系统通过`api.py`模块调用AI模型，支持多种模型，包括GPT-4、GPT-4.1、GPT-4o等。AI调用的核心流程如下：

1. **构建请求**：根据提示词模板和用户输入，构建API请求
2. **发送请求**：调用requests库发送HTTP请求到AI服务
3. **处理响应**：解析API响应，提取AI生成的内容
4. **错误处理**：处理API请求失败、JSON解析失败等异常情况
5. **重试机制**：实现请求重试功能，提高可靠性

## 4. 关键代码分析

### 4.1 主入口文件 (main.py)

```python
# 设置日志
logger = setup_logger(__name__)

def main():
    """主函数"""
    try:
        logger.info(f"启动{APP_NAME} v{APP_VERSION}")
        
        # 直接启动应用程序，数据库初始化在后台进行
        app = SixYaoApp()
        
        # 在后台线程中进行数据库初始化
        import threading
        init_thread = threading.Thread(target=app.background_initialization, daemon=True)
        init_thread.start()
        
        app.mainloop()
        
    except Exception as e:
        logger.error(f"应用程序启动失败: {str(e)}")
        logger.error(traceback.format_exc())
        print(f"\n应用程序启动失败: {str(e)}")
        input("按回车键退出...")
```

### 4.2 应用类 (gui/app.py)

```python
class SixYaoApp(ctk.CTk):
    """主应用程序类"""
    
    def __init__(self):
        super().__init__()
        
        # 初始化状态变量
        self.database_built = False
        self.initialization_complete = False
        self.initialization_progress = 0
        
        # 获取UI设置
        self.ui_settings = get_ui_settings()
        
        # 设置应用程序外观
        ctk.set_appearance_mode(self.ui_settings["appearance_mode"])
        ctk.set_default_color_theme("green")
        
        # 配置窗口
        self.title(APP_NAME)
        self.geometry(f"{self.ui_settings['window_width']}x{self.ui_settings['window_height']}")
        self.minsize(800, 600)
        
        # 初始化历史记录管理器
        self.history_manager = HistoryManager()
        
        # 创建UI组件
        self.create_widgets()
        
        # 应用主题颜色
        self.apply_theme_colors()
        
        # 绑定事件
        self.bind("<Configure>", self.on_resize)
        
        # 设置窗口关闭协议
        self.protocol("WM_DELETE_WINDOW", self.on_closing)
        
        # 初始化时禁用功能按钮
        self.disable_ui_during_initialization()
        
        # 显示初始化状态
        self.update_initialization_status("正在初始化应用程序...", 0)
```

### 4.3 API调用 (api.py)

```python
def AI(text: str, model: str = "gpt-4", agent: str = "chat") -> str:
    """调用AI模型进行文本生成"""
    try:
        # 调用OpenAI API
        url = "https://gateway.api.airapps.co/aa_service=server5/aa_apikey=5N3NR9SDGLS7VLUWSEN9J30P//v3/proxy/open-ai/v1/chat/completions"
        headers = {
            "Host": "gateway.api.airapps.co",
            "Content-Type": "application/json",
            "User-Agent": "iOS-TranslateNow/8.17.2.1001 CFNetwork/3826.500.111.2.2 Darwin/24.4.0",
            "Connection": "keep-alive",
            "Accept": "*/*",
            "Accept-Language": "zh-CN,zh-Hans;q=0.9",
            "Air-User-Id": "49CE3053-FC0C-4FB0-9F6F-141EF7CA5DE8"
        }
        
        # 构建请求数据
        data = {
            "model": model,
            "top_p": 0.3,
            "messages": [
                {
                    "role": "system", 
                    "content": agent
                },
                {
                    "role": "user",
                    "content": text
                }
            ],
            "temperature": 0.3,
            "stream": False
        }
        
        # 发送请求并计时
        max_retries = 3
        retry_delay = 5  # 重试间隔时间（秒）
        res = None
        for attempt in range(max_retries):
            try:
                start_time = time.time()
                res = requests.post(url, headers=headers, json=data, timeout=60)
                res.encoding = 'utf-8'
                elapsed_time = time.time() - start_time
                logger.info(f"OpenAI API响应时间: {elapsed_time:.2f}秒")
                
                # 检查HTTP状态码
                res.raise_for_status()
                break  # 请求成功，跳出重试循环
            except requests.RequestException as e:
                if attempt < max_retries - 1:
                    logger.warning(f"API请求失败（尝试{attempt+1}/{max_retries}），{retry_delay}秒后重试: {str(e)}")
                    time.sleep(retry_delay)
                else:
                    logger.error(f"API请求失败，已达到最大重试次数: {str(e)}")
                    raise  # 最后一次尝试失败，抛出异常
        
        # 解析JSON响应
        result = res.json()
        
        # 检查响应格式是否正确
        if 'choices' not in result or len(result['choices']) == 0:
            raise ValueError(f"API响应格式不正确: {result}")
            
        return result['choices'][0]['message']['content']
        
    except requests.RequestException as e:
        logger.error(f'API请求失败: {str(e)}')
        return f"API请求失败，请稍后再试。错误: {str(e)}"
    except json.JSONDecodeError as e:
        logger.error(f'JSON解析失败: {str(e)}')
        return f"API响应解析失败，请稍后再试。错误: {str(e)}"
    except Exception as e:
        logger.error(f'AI响应处理失败: {str(e)}')
        return f"处理失败，请稍后再试。错误: {str(e)}"
```

### 4.4 提示词管理 (src/prompts.py)

系统的提示词文件包含了所有AI分析所需的提示词模板，主要包括：

1. **用神判断提示词** (`YONGSHEN_CHAT_PROMPT`)
2. **六爻分析提示词** (`SIXYAO_ANALYSIS_PROMPT`)
3. **用神卦理分析提示词** (`YONGSHEN_GULI_ANALYSIS_PROMPT`)
4. **动爻卦理分析提示词** (`DONGYAO_GULI_ANALYSIS_PROMPT`)
5. **数字量化分析提示词** (`SHUZI_LIANGHUA_ANALYSIS_PROMPT`)
6. **日破暗动判断提示词** (`RIPO_ANDONG_ANALYSIS_PROMPT`)
7. **六爻解读提示词** (`SIXYAO_INTERPRETATION_PROMPT`)
8. **其他易学体系提示词** (奇门遁甲、大六壬、金口诀等)

以下是六爻解读提示词的示例：

```python
SIXYAO_INTERPRETATION_PROMPT = '''【角色定位】
you are一位精通六爻预测术的专业大师，具备深厚的易学理论基础和丰富的实践经验。你的任务是根据用户提供的卦象信息及问题，提供准确、专业的解读。

【输入格式说明】
用户输入格式为：问题：[用户原始问题]  分析方面：[具体分析角度]
卦象信息包含：本卦、变卦、六亲、六神、世应、动爻等关键信息。
you需要基于这些信息，结合六爻卦理进行精准解读。

【解读方法】
1. 首先参考用神判断结果，明确解读的核心焦点
2. 结合用神卦理分析，深入理解用神的状态和影响
3. 参考动爻卦理分析，重点关注动爻所代表的变化信息
4. 利用数字量化分析结果，准确评估各爻的力量对比
5. 分析世爻与应爻的关系，确定问题的基本态势
6. 分析六亲、六神的组合关系，挖掘更深层次的信息
7. 考虑本卦与变卦的关系，预测事情的发展趋势
8. 结合用户的具体问题和分析方面，给出针对性的解读

【输出要求】
1. 提供一段简洁、专业的解读，直接切入核心问题，不要过多赘述
2. 解读必须紧密结合用户的实际情况，避免泛泛而谈
3. 每个结论后必须附加支撑该结论的卦理依据，使用括号标注
4. 只提供客观分析结论，不要给出任何建议或指导性意见
5. 使用平实、专业的语言，不使用markdown格式
6. 解读长度控制在100-200字之间，精炼有力
'''```

## 5. 配置管理

### 5.1 配置文件结构

系统使用JSON格式存储配置信息，主要包括：

1. **应用常量**：APP_NAME、APP_VERSION、LANGUAGES等
2. **日志设置**：LOG_FILE、LOG_LEVEL、LOG_FORMAT等
3. **UI设置**：窗口大小、字体、颜色主题等
4. **API设置**：API_TIMEOUT、API_RETRY_COUNT、API_RETRY_DELAY等
5. **模型设置**：DEFAULT_MODEL、SUPPORTED_MODELS等
6. **主题设置**：iOS风格的明亮/暗黑主题配色

### 5.2 配置管理器

`utils/config_manager.py`提供了配置管理功能，支持配置的加载、保存、获取和设置：

```python
class ConfigManager:
    """配置管理器"""
    
    def __init__(self, config_file: str = "app_config.json"):
        self.config_file = config_file
        self.config_data: Dict[str, Any] = {}
        self.load_config()
    
    def load_config(self) -> None:
        """加载配置文件"""
        try:
            if os.path.exists(self.config_file):
                with open(self.config_file, 'r', encoding='utf-8') as f:
                    self.config_data = json.load(f)
                logger.info(f"成功加载配置文件: {self.config_file}")
            else:
                logger.info(f"配置文件不存在，使用默认配置: {self.config_file}")
                self.config_data = {}
        except Exception as e:
            logger.error(f"加载配置文件失败: {str(e)}")
            self.config_data = {}
    
    def save_config(self) -> bool:
        """保存配置文件"""
        try:
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(self.config_data, f, ensure_ascii=False, indent=2)
            logger.info(f"成功保存配置文件: {self.config_file}")
            return True
        except Exception as e:
            logger.error(f"保存配置文件失败: {str(e)}")
            return False
    
    def get(self, key: str, default: Any = None) -> Any:
        """获取配置值"""
        return self.config_data.get(key, default)
    
    def set(self, key: str, value: Any) -> None:
        """设置配置值"""
        self.config_data[key] = value
```

## 6. 历史记录管理

### 6.1 历史记录数据模型

系统使用`dataclass`定义历史记录的数据模型：

```python
@dataclass
class HistoryRecord:
    """历史记录数据模型"""
    id: str
    timestamp: str
    question: str
    divination_method: str
    yongshen: str
    fangmian: str
    model: str
    hexagram_info: str
    analysis_result: str
    tags: List[str] = None
    chat_messages: List[Dict[str, Any]] = None
```

### 6.2 历史记录管理器

`utils/history.py`提供了历史记录的存储、查询、管理功能：

```python
class HistoryManager:
    """历史记录管理器"""
    
    def __init__(self, history_file: str = "data/history.json"):
        self.history_file = history_file
        self.records: List[HistoryRecord] = []
        self.load_history()
    
    def load_history(self) -> None:
        """加载历史记录"""
        # 实现历史记录加载逻辑
    
    def save_history(self) -> bool:
        """保存历史记录"""
        # 实现历史记录保存逻辑
    
    def add_record(self, question: str, divination_method: str, yongshen: str, fangmian: str, model: str,
                   hexagram_info: str, analysis_result: str, tags: List[str] = None,
                   chat_messages: List[Dict[str, Any]] = None) -> str:
        """添加新记录"""
        # 实现添加历史记录逻辑
    
    def search_records(self, keyword: str = "", divination_method: str = "", 
                      start_date: str = "", end_date: str = "") -> List[HistoryRecord]:
        """搜索历史记录"""
        # 实现历史记录搜索逻辑
```

## 7. UI设计与实现

### 7.1 UI框架

系统使用`customtkinter`库实现现代化的GUI界面，采用了iOS风格的设计，包括：

- 卡片式布局
- 圆角设计
- 渐变色彩
- 平滑动画
- 主题切换（明亮/暗黑）

### 7.2 核心UI组件

1. **HeaderFrame**：应用标题和版本信息
2. **InputFrame**：问题输入、起卦方式选择、分析按钮
3. **NotebookFrame**：包含多个选项卡，用于显示卦象信息、解读结果、聊天界面和历史记录
4. **StatusFrame**：显示应用状态和进度

### 7.3 主题切换

系统支持明亮/暗黑主题切换，通过`toggle_theme`方法实现：

```python
def toggle_theme(self):
    """切换主题模式（明亮/暗黑）"""
    try:
        # 显示加载状态
        self.status_frame.update_status("正在切换主题...") if hasattr(self, 'status_frame') else None
        self.update_idletasks()  # 立即更新UI
        
        # 取消之前的主题切换任务（如果有）
        if hasattr(self, '_theme_job') and self._theme_job:
            self.after_cancel(self._theme_job)
        
        # 延迟执行主题切换，减少频繁切换导致的闪烁
        self._theme_job = self.after(50, self._apply_theme_change)
    except Exception as e:
        logger.error(f"切换主题时出错: {e}")
```

## 8. 动画效果

系统实现了多种动画效果，包括：

1. **启动动画**：应用启动时的平滑过渡效果
2. **打字机效果**：AI回复时的打字机效果
3. **脉冲动画**：加载状态的脉冲效果
4. **主题切换动画**：主题切换时的平滑过渡

## 9. 错误处理与日志

### 9.1 错误处理

系统实现了全面的错误处理机制，包括：

1. **API请求错误处理**：处理网络错误、超时等情况
2. **JSON解析错误处理**：处理AI响应格式错误
3. **UI组件错误处理**：处理UI组件创建和更新时的错误
4. **文件操作错误处理**：处理文件读写错误

### 9.2 日志系统

系统使用Python内置的`logging`模块实现日志管理，支持不同级别的日志记录：

```python
def setup_logger(name):
    """设置日志记录器"""
    # 实现日志设置逻辑
    return logger
```

日志文件默认保存为`app.log`，包含了应用启动、API调用、错误信息等详细记录。

## 10. 性能优化

### 10.1 后台初始化

系统将数据库初始化等耗时操作放在后台线程中执行，避免阻塞UI线程，提高应用响应速度。

### 10.2 动画优化

系统对动画效果进行了优化，包括：

- 减少动画时长
- 减少动画步数
- 使用更简单的动画缓动函数
- 启用性能模式

### 10.3 防抖动处理

系统实现了窗口调整的防抖动处理，减少频繁调整窗口导致的性能问题：

```python
def on_resize(self, event):
    """窗口大小变化时的处理 - 添加防抖动逻辑"""
    # 只处理来自主窗口的调整事件
    if event.widget == self:
        # 取消之前的调整计划（如果有）
        if hasattr(self, '_resize_job') and self._resize_job:
            self.after_cancel(self._resize_job)
        
        # 设置新的调整计划，延迟100毫秒执行
        self._resize_job = self.after(100, self._apply_resize)
```

## 11. 部署与运行

### 11.1 依赖安装

使用以下命令安装项目依赖：

```bash
pip install -r requirements.txt
```

### 11.2 启动应用

使用以下命令启动应用：

```bash
python main.py
```

或者直接运行`start.bat`脚本：

```batch
@echo off
python main.py
pause
```

## 12. 扩展与定制

### 12.1 添加新的易学体系

要添加新的易学体系，需要：

1. 在`config/settings.py`的`DIVINATION_METHODS`中添加新的易学体系
2. 在`src/prompts.py`中添加对应的分析和解读提示词
3. 在`gui/frames/input_frame.py`中添加新的易学体系选项
4. 在`gui/app.py`的`perform_analysis`方法中添加新的易学体系处理逻辑

### 12.2 定制AI模型

系统支持多种AI模型，可以在`config/settings.py`的`SUPPORTED_MODELS`中添加新的模型。

### 12.3 定制主题

可以在`config/themes.py`中修改现有主题或添加新的主题配色方案。

## 13. 总结

AI六爻分析系统是一款功能强大、设计现代化的易学分析工具，通过AI技术实现了传统易学与现代科技的结合。系统架构清晰，模块划分合理，代码结构良好，便于扩展和定制。

系统的核心优势包括：

1. **多种易学体系支持**：支持六爻、奇门遁甲、大六壬、金口诀等多种易学体系
2. **专业的AI分析**：通过精心设计的提示词，实现准确的卦象解析和解读
3. **现代化的UI设计**：采用iOS风格的设计，提供良好的用户体验
4. **全面的历史记录管理**：支持历史记录的保存、查询、导出等功能
5. **灵活的配置和扩展**：支持主题切换、模型定制等功能

通过本技术文档，开发者可以全面了解系统的架构、功能和实现细节，便于进行二次开发和定制。