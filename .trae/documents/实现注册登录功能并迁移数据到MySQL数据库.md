# 实现注册登录功能并迁移数据到MySQL数据库

## 1. 项目结构调整
为了避免将所有代码都挤在app.py中，我将按照功能模块组织代码：

| 文件名 | 功能描述 |
|--------|----------|
| app.py | 主应用入口，包含基本配置和路由注册 |
| models.py | 数据库模型定义 |
| auth.py | 用户认证功能（注册、登录、登出等） |
| captcha.py | 图形验证码生成和验证 |
| hexagram.py | 解卦相关功能 |
| models_manager.py | 自定义模型管理功能 |
| config.py | 配置文件，包含数据库连接信息等 |

## 2. 安装必要的依赖
- Flask-SQLAlchemy：用于数据库操作
- Flask-Login：用于用户认证
- Flask-Captcha：用于生成图形验证码
- mysqlclient：用于连接MySQL数据库
- passlib：用于密码哈希

## 3. 配置文件（config.py）
- 数据库连接配置
- 应用密钥配置
- 验证码配置

## 4. 数据库模型（models.py）
### 用户表（User）
- id：主键
- username：用户名
- password_hash：密码哈希值
- created_at：创建时间

### 自定义模型表（CustomModel）
- id：主键
- user_id：外键，关联用户表
- name：模型名称
- api_url：API地址
- api_key：API密钥
- description：模型描述
- created_at：创建时间

### 解卦记录表（HexagramRecord）
- id：主键
- user_id：外键，关联用户表
- record_id：记录ID（保持原有UUID格式）
- question：问题
- hexagram_info：卦象信息
- model：使用的模型
- yongshen：用神判断结果
- yongshen_guli：用神卦理分析
- dongyao_guli：动爻卦理分析
- shuzi_lianghua：数字量化分析
- zonghe_jiedu：综合解读
- timestamp：解卦时间

## 5. 图形验证码（captcha.py）
- 生成图形验证码
- 验证图形验证码
- 验证码存储（使用session）

## 6. 用户认证（auth.py）
- **注册功能**：
  - 验证用户名是否已存在
  - 验证密码强度
  - 验证图形验证码
  - 密码哈希存储
- **登录功能**：
  - 验证用户名和密码
  - 验证图形验证码
  - 登录状态管理
- **登出功能**：
  - 清除用户会话
- **会话管理**：
  - 使用Flask-Login管理用户会话
  - 实现UserMixin接口

## 7. 解卦功能（hexagram.py）
- 解卦API
- 解卦记录存储到数据库
- 解卦结果查询
- 历史记录管理

## 8. 自定义模型管理（models_manager.py）
- 自定义模型的增删改查
- 模型列表查询
- 模型配置存储到数据库

## 9. 路由保护
- 使用@login_required装饰器保护需要登录的路由
- 保护的路由包括：
  - 历史记录页面
  - 设置页面
  - 解卦API

## 10. 防止SQL注入
- 使用Flask-SQLAlchemy的ORM查询，避免直接拼接SQL语句
- 对用户输入进行验证和过滤

## 11. 密码安全
- 使用passlib的bcrypt算法加密密码
- 密码哈希存储，防止明文泄露

## 12. 实现步骤
1. 创建项目结构，拆分代码文件
2. 安装依赖
3. 创建配置文件
4. 定义数据库模型
5. 实现图形验证码功能
6. 实现用户认证功能
7. 修改自定义模型管理功能
8. 修改解卦记录管理功能
9. 添加路由保护
10. 测试所有功能

## 13. 注意事项
- 数据库连接信息要安全存储
- 图形验证码要难破解，但也要容易识别
- 路由保护要全面，防止未授权访问
- 密码使用强哈希算法加密
- 代码结构清晰，便于维护和扩展

## 14. 预期效果
- 用户可以注册登录
- 自定义模型配置存储在数据库中，关联到具体用户
- 解卦记录存储在数据库中，关联到具体用户
- 注册登录时需要图形验证码验证
- 密码使用哈希算法加密存储
- 防止SQL注入
- 数据安全可靠
- 代码结构清晰，便于维护和扩展